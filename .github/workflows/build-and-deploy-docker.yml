name: Build and deploy Docker Image

on:
  push:
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
      - 'CODEOWNERS'
      - 'test/**'
    branches:
      - master
  workflow_dispatch:

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  BASE_IMAGE: ghcr.io/${{ github.repository }}
  MAJOR_VERSION: "2"

jobs:
  docker:
    name: Build and deploy Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Hente kode
        uses: actions/checkout@v3

      - name: Sette opp Node
        uses: actions/setup-node@v3
        with:
          node-version: '16.x'

      - name: Bygge app & kjÃ¸re integration tests
        shell: bash
        run: |
          echo ${GITHUB_TOKEN} | docker login ghcr.io --username ${GITHUB_REPOSITORY} --password-stdin
          cd startup-utils
          ./start-for-integration-tests.sh --detach
          cd ../integration-tests
          npm install
          npm run test
          cd ../startup-utils
          docker-compose down
          cd ..

      - name: Sette Docker variabler
        run: |
          echo "TAG=${MAJOR_VERSION}.$(date "+%Y.%m.%d")-$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "RC_TAG=${MAJOR_VERSION}.$(date "+%Y.%m.%d")-$(git rev-parse --short HEAD)-RC" >> $GITHUB_ENV

      - name: Bygg & last opp Docker image (Release)
        if: github.ref == 'refs/heads/master' && !contains(github.event.head_commit.message, 'ci skip')
        run: |
          docker build --pull --tag ${BASE_IMAGE}:${TAG} --tag ${BASE_IMAGE}:latest .
          echo ${GITHUB_TOKEN} | docker login ghcr.io --username ${GITHUB_REPOSITORY} --password-stdin
          docker push ${BASE_IMAGE}:${TAG}
          docker push ${BASE_IMAGE}:latest

      - name: Run Trivy vulnerability scanner on docker image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${BASE_IMAGE}:${TAG}
          ignore-unfixed: true
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Bygg & last opp Docker image (Release Candidate)
        if: github.ref != 'refs/heads/master'
        run: |
          docker build --pull --tag ${BASE_IMAGE}:${RC_TAG} .
          echo ${GITHUB_TOKEN} | docker login ghcr.io --username ${GITHUB_REPOSITORY} --password-stdin
          docker push ${BASE_IMAGE}:${RC_TAG}
