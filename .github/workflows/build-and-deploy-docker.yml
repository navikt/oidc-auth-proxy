name: Build and deploy Docker Image

on:
  push:
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
      - 'CODEOWNERS'
      - 'test/**'
    branches:
      - master

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  DOCKER_IMAGE: docker.pkg.github.com/${{ github.repository }}/oidc-auth-proxy
  DOCKER_IMAGE_GH: ghcr.io/${{ github.repository }}

jobs:
  docker:
    name: Build and deploy Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Hente kode
        uses: actions/checkout@v1

      - name: Sette opp Node
        uses: actions/setup-node@v1
        with:
          node-version: '15.x'

      - name: Bygge app & kjÃ¸re integration tests
        shell: bash
        run: |
          echo ${GITHUB_TOKEN} | docker login docker.pkg.github.com -u ${GITHUB_REPOSITORY} --password-stdin
          cd startup-utils
          ./start-for-integration-tests.sh --detach
          cd ../integration-tests
          npm install
          npm run test
          cd ../startup-utils
          docker-compose down
          cd ..

      - name: Bygg & last opp Docker image
        run: |
          echo "TAG=$(date "+%Y.%m.%d")-$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          docker build . --pull -t ${DOCKER_IMAGE}:${TAG}
          echo ${GITHUB_TOKEN} | docker login docker.pkg.github.com -u ${GITHUB_REPOSITORY} --password-stdin
          docker push ${DOCKER_IMAGE}:${TAG}
          docker tag ${DOCKER_IMAGE}:${TAG} ${DOCKER_IMAGE}:latest
          docker push ${DOCKER_IMAGE}:latest
          docker build --pull --tag ${DOCKER_IMAGE_GH}:${TAG} --tag ${DOCKER_IMAGE_GH}:latest .
          echo ${GITHUB_TOKEN} | docker login --username ${GITHUB_REPOSITORY} --password-stdin ghcr.io
          docker push ${DOCKER_IMAGE_GH}:${TAG}
          docker push ${DOCKER_IMAGE_GH}:latest
